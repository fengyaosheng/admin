### 任务58: 权限管理: 分析

权限管理由2部分组成

```
权限数据管理: 对权限相关数据进行CRUD操作
权限控制: 控制用户只能看到有权限的路由页面和有权限的操作按钮
```

有2个用户

```
admin/111111: 超级管理员, 可以看到所有的路由页面及页面上的所有操作按钮
test44/111111: 普通用户, 只能看到部分路由页面及页面上的部分操作按钮
```

权限控制的级别:

```
路由(页面)级别: 有权限的页面才可见 ==> 如果访问一个没有权限的路由路径, 自动跳转到404页面
按钮级别: 有权限的按钮才可见
```

当前项目的导航菜单路由:

```
首页: 任意登陆用户都可见
商品管理: 只有有对应权限的登陆用户才可见
```

什么时候获取用户的权限数据?

```
哪个接口返回的?: /admin/acl/index/info 根据token获取用户信息的接口返回
什么时候请求这个接口呢?
	>> 登陆请求成功后       注意: 登陆请求本身只是返回了token, 没有用户和权限信息数据
	>> 打开访问/刷新页面(token在有效期内)    ==> 实现了自动登陆的效果
代码中到底在哪发的请求: 在路由全局前置守卫中
```

用户权限相关数据结构?

```
roles: ['普通管理员']    // 当前用户所属角色
routes: ['Product', 'Attr']  // 当前用户有权限的路由标识名称, 需要与路由配置的name对应
buttons: ["btn.Attr.add",  "btn.Trademark.add"] // 当前用户有权限的按钮的标识名称
```

注册路由的2种方式:

```
静态注册: 创建路由器时注册 ===> 一般在页面初始化时就会执行    ==> 任何用户都可以访问
    new Router({
        routes: [路由1, 路由2]
    })

动态注册:  需要动态添加注册  ==> 发生在用户请求得到自己路由权限数据后执行   ==> 当前用户可访问的
	router.addRoutes([路由3, 路由4])
```

路由分类:

```
常量路由: 用户不登陆或任意用户登陆后都可以访问的路由  ==> 静态注册
异步/权限路由: 根据登陆用户异步请求得到的路由权限数据确定的路由 ==> 动态注册
匹配任意的路由: 所有不与常量/异步路由匹配的路由跳转, 直接重定向到404页面  ==> 必须是最后注册
```

路由权限生效:

```
动态注册了当前用户的权限路由和any路由
当前用户对应的左则导航菜单确定了: 常量路由 + 权限路由
```

路由权限生效的基本流程

```
1.初始化时, 创建路由器并注册常量路由
2.登陆成功或刷新(token有效)时, 根据token得到用户的路由权限数据
3.根据路由权限数据, 确定当前用户的所有权限路由的数组
4.动态注册权限路由和any路由, 
5.根据常量路由和权限路由生成导航菜单
```



### 任务59: 权限控制: 编码实现

1.初始化时, 创建路由器并注册常量路由

```
根据路由3种分类拆分路由并分别暴露: router/routes.js
	常量路由的数组 / 所有异步路由的数组 / any路由对象
静态注册常量路由: router/index.js
	new Router({routes})
```

2.登陆成功或刷新(token有效)时, 根据token得到用户的路由权限数据

```
在permission.js中的全局前置守卫中:  分发请求获取用户权限数据的action
	await store.dispatch('user/getInfo')
在vuex的user.js中: 调用接口请求函数, 获取用户权限数据
    getInfo () {
        const result = await getInfo()
        const { name, avatar, roles, buttons, routes} = result.data
    }
```

3.根据路由权限数据, 确定当前用户的所有权限路由的数组: 

```
routes: ['Product', 'Attr', 'Trademark']
通过filterAsyncRoutes()对allAsyncRoutes进行深度过滤:  filter + 递归
```

4.动态注册权限路由和any路由, 

```
router.addRoutes([...asyncRoutes, anyRoute])
```

5.根据常量路由和权限路由生成导航菜单

```
合并常量路由和权限路由生成routes, 并保存到state中: store/modules/user.js
	commit('SET_ROUTES', constantRoutes.concat(asyncRoutes))
将user中的routes映射到getters中: store/getters.js
	routes: state => state.user.routes,
让左则导航组件SideBar读取routes, 显示导航菜单列表: layout/components/SideBar
```

bug1:     模板项目自身代码的问题

```js
描述: 在权限路由上刷新/登陆成功后跳转到权限路由, 页面是空白的
原因: 在请求获取用户信息(包含路由权限)后, 自动动态添加了权限路由
	但由于这个操作发生在一次路由跳转的过程中, 这次的路由跳转是看不到新添加的路由
	只有再次跳转一下, 才能看到最新添加的异步路由
解决:
	// next() // 放行, 没有重新跳转, 看不到最新添加的动态路由
	// next(to.path) // 重新跳转到目标路由, 但丢失了参数(如果有的话)
	next({...to}) // 重新跳转到目标路由, 且参数不会丢失
```

bug2: 我们代码的问题

```
描述: 如果先用一个A用户登陆, 退出后用B用户登陆, 结果看到与A用户相同部分的菜单是
原因:  我们在过滤总的异步路由数组中, 过滤掉了内部部分子路由, 另一个用户登陆看不到总的路由数组了
解决: 深拷贝然后再进行过滤 ==> 不去改变总的异步路由数组
```

实现按钮权限控制

```js
按钮权限数据: 
    在哪?  vuex的user模块的state中  ==> 映射到getters中了 butttons
    结构: ['按钮1权限值', '按钮2权限值']  ==>  ["btn.Attr.add",  "btn.Trademark.add"] 
如何判断当前用户是否有某个按钮的权限?
	定义判断的函数, 接收特定按钮的权限值, 返回是否有权限的布尔值
	function hasBtnPermission (btnPer)  {
		return store.getters.buttons.includes(btnPer)
	}
将判断的函数挂载到Vue的原型上, 让所有组件都可见
	Vue.prototype.$hasBP = hasBtnPermission
在权限组件中利用$hasBP来判断是否显示某个功能按钮
	v-if="$hasBP('btn.Attr.update')"    权限值去菜单管理列表中查看
```

退出登陆, 为什么要重置路由器中的路由?

```
重置路由器中的路由:  让路由器中的路由从包含常量路由/异步路由/any路由变为常量路由
	如果不重置, 退出后通过另一个用户登陆, 还能访问前一个用户有权限, 当前用户没权限的路由
	如果重置了, 退出后通过另一个用户登陆, 用户能访问的只能是常量路由和当前用户的权限路由
	如果还访问前一个用户特有的权限路由, 就会出404页面
```

如何重置路由?

```
// 创建一个新的只注册了常量路由的路由器
const newRouter = createRouter()
// 将新的router的macher对象替换为router的matcher
// 所有注册的路由在matcher内部
router.matcher = newRouter.matcher // reset router
```

总结一下permission.js的整体流程

```
判断是否有token?
	>> 有    判断要去是否是login页面?
		=>> 是: 强制跳转去首页
		=>> 不是  判断是否已经登陆?
			==> 已经: 放行
			==> 还没有  发送获取用户信息的请求实现登陆(用户信息和注册权限路由)
					===> 成功了: 强制重新跳转到目标页面(解决刷新空白的bug)
					===> 失败了: 清除token及用户相关信息, 强制跳转到login页面
	>> 没有   判断要去的页面是否需要token?
		=>> 不需要: 放行
		=>> 需要: 强制跳转到login页面
```

